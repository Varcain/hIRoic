#include "dsp.h"
#include "arm_math.h"
#include "app_conf.h"

#define COEF_MAX 4096

q31_t coef[460] = {
1661309, 4930648, 7210357, 7969177, 7723002, 5464464, 1984651, -794875,
-2796633, -3648160, -2653684, -836352, 464958, 1365160, 1972757, 1848331,
1180310, 731415, 717919, 922550, 1275760, 1582588, 1453341, 1049706,
603812, 209076, 107894, 214546, 481429, 761787, 712907, 274775,
59021, 104408, -34271, -191000, 2029, 330768, 529940, 744128,
939604, 984893, 819031, 480627, 155519, 58231, -11306, -169842,
-225034, -269277, -327872, -277797, -167466, 6559, 216122, 344417,
401998, 392012, 287314, 120829, 32078, -42779, -147295, -219221,
-331460, -517333, -633749, -585849, -381404, -107821, 112302, 173400,
140034, 73189, -98481, -327596, -533992, -682236, -691383, -586081,
-377214, -135576, 11395, 35484, -27636, -94583, -156194, -260365,
-372756, -506796, -729598, -1014327, -1227488, -1324328, -1308442, -1147178,
-898656, -675775, -434568, -186190, -34530, -12042, -62766, -169751,
-247655, -224762, -154416, -86099, -34684, -90304, -291921, -577258,
-854364, -1042891, -1125208, -1102981, -960011, -697752, -373692, -68320,
129467, 147499, 38310, -135702, -336464, -508343, -613859, -656458,
-632766, -590802, -554812, -539828, -535479, -552653, -575539, -551254,
-479208, -388482, -280932, -188891, -148600, -187472, -282625, -403278,
-506668, -556003, -574908, -596398, -606886, -621437, -657285, -683028,
-676190, -669889, -663549, -635631, -592443, -551325, -517988, -519606,
-555615, -596282, -626946, -662941, -682516, -685371, -686464, -672695,
-626150, -584311, -557855, -526945, -479535, -425720, -372816, -341146,
-330796, -335401, -337198, -344065, -339651, -309170, -264948, -212230,
-153116, -114407, -105583, -126220, -164109, -205744, -244452, -276518,
-286997, -283497, -277057, -291742, -335523, -397582, -442113, -447574,
-410165, -354889, -298079, -251432, -213423, -184756, -163122, -148486,
-133147, -129174, -133040, -138719, -151226, -175940, -193406, -195089,
-174635, -140435, -106748, -85264, -78475, -84803, -88275, -92405,
-106339, -131515, -152085, -162595, -158666, -144259, -121234, -99659,
-75353, -56763, -60452, -96771, -142862, -183279, -202670, -199021,
-183345, -164038, -139892, -121563, -103946, -84017, -64141, -47798,
-20249, 25239, 83609, 134201, 165847, 169888, 165044, 164379,
164671, 158121, 154150, 158238, 182871, 229292, 280488, 305316,
300563, 284789, 277340, 272924, 261241, 228559, 183737, 142701,
123369, 129259, 157078, 188428, 218321, 250473, 284389, 309007,
315436, 296496, 269260, 247927, 240640, 235263, 221857, 200672,
182100, 167269, 165164, 172153, 174442, 165984, 164527, 175148,
196368, 219246, 244733, 263761, 265484, 244305, 211447, 177163,
158047, 154144, 161598, 173965, 190889, 212654, 243821, 273860,
302251, 330552, 354080, 360813, 347935, 312144, 270099, 235188,
226173, 257372, 312481, 348572, 346610, 313908, 279990, 261089,
253705, 250530, 253648, 256113, 260114, 261465, 262653, 266349,
278073, 301732, 342623, 391215, 434624, 448272, 431477, 400675,
379375, 374685, 383163, 392672, 398699, 393113, 376135, 347456,
314434, 282313, 262187, 252215, 250340, 256549, 271266, 284861,
292427, 300183, 321547, 343605, 349700, 332540, 296851, 248744,
199731, 159437, 139757, 137221, 143568, 149163, 161016, 184377,
214094, 231485, 235729, 234797, 239760, 248530, 261567, 278008,
300532, 320650, 340412, 358180, 365448, 351189, 324367, 300180,
294239, 307454, 329377, 337892, 325254, 298077, 271287, 246776,
226206, 210965, 204223, 205353, 222389, 246375, 265331, 271910,
269346, 262684, 261642, 265233, 268404, 263395, 249472, 221831,
193124, 175676, 171894, 175409, 181147, 187081, 196383, 204761,
214513, 223996, 230166, 230470, 231660, 236498, 249634, 263781,
272982, 271766, 259570, 231948, 191941, 148674, 118520, 105736,
107432, 114281, 125499, 142958, 160892, 165746, 162931, 162017,
169763, 181232, 197076, 214944, 225715, 223426, 219779, 219325,
218365, 209609, 192655, 161471
};


q31_t post_fir_coef[33] = {
-2343235, 2499567, 4880647, -2975471, -11937085, 1224827, 24793591, 7755882,
-42874693, -30925506, 63616180, 79898641, -83042216, -189483262, 96890144, 669917788,
971692048, 669917788, 96890144, -189483262, -83042216, 79898641, 63616180, -30925506,
-42874693, 7755882, 24793591, 1224827, -11937085, -2975471, 4880647, 2499567,
-2343235
};
#define POST_FIR_COEF_LEN 33


q31_t post_fir_state[POST_FIR_COEF_LEN + DSP_BUFFER_SIZE - 1];

q31_t coefReversed[COEF_MAX];
q31_t state[COEF_MAX + DSP_BUFFER_SIZE - 1];
q31_t scratch1[DSP_BUFFER_SIZE];
q31_t scratch2[DSP_BUFFER_SIZE];

arm_fir_instance_q31 inst;
arm_fir_instance_q31 post_fir_inst;

unsigned int coefSize;

void dsp_init(void)
{
	coefSize = sizeof(coef) / sizeof(float);
	dsp_loadIR((int *)coef, coefSize, 44100, 24);
	arm_fir_init_q31(&post_fir_inst, POST_FIR_COEF_LEN, post_fir_coef, post_fir_state, DSP_BUFFER_SIZE);
}

void dsp_process (int *out, int *in,  unsigned int size)
{
	int i;

	for (i = 0; i < DSP_BUFFER_SIZE; i++) {
		in[i] >>= 2;
	}
	arm_fir_q31(&inst, (q31_t*)in, (q31_t*)scratch1, DSP_BUFFER_SIZE);
	arm_fir_q31(&post_fir_inst, (q31_t*)scratch1, (q31_t*)out, DSP_BUFFER_SIZE);
}

void dsp_convert_bitsize(int *out, int *in, unsigned char outBitSize, unsigned char inBitSize, unsigned int size)
{
	int i;
	unsigned char shift;

	if (outBitSize > inBitSize) {
		shift = outBitSize - inBitSize;
		for (i = 0; i < size; i++) {
			out[i] = in[i] * (1 << shift);
		}
	} else {
		shift = inBitSize - outBitSize;
		for (i = 0; i < size; i++) {
			out[i] = in[i] / (1 << shift);
		}
	}
}

void dsp_loadIR(int *ir, unsigned int length, unsigned int bitSize, unsigned int fs)
{
	int i;

	if (bitSize != DSP_BITSIZE) {
		dsp_convert_bitsize(ir, ir, DSP_BITSIZE, bitSize, length);
	}
	if (fs != DSP_RATE) {
		/* unhandled ATM */
	}

	for (i = 0; i < length; i++) {
		coefReversed[i] = ir[length - i];
	}

	arm_fir_init_q31(&inst, length, coefReversed, state, DSP_BUFFER_SIZE);
}
